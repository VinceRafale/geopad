extends ../layout

block content

    #container
        h1 #{pad.name} 
        .pad-meta-data 
            span #{pad.radius} m 
            if pad.expiry 
                / Expires #{pad.expiry}

        form#newpost(action="/api/post/new/", method="GET")
            textarea#post-body
            input#pad-uuid(type="hidden", name="uuid", value="#{pad.uuid}") 
            input.btn(type="submit", value="Post")

        #post-error
        #postlist
        for post in posts
            include ../snippets/post_detail

block script
    script.

        var user_lat, user_long;

        geo_success = function(position) {
            // save the user's position as a global variable 
            user_lat = position.coords.latitude;
            user_long = position.coords.longitude;
            accuracy = position.coords.accuracy;
            console.log("obtained user location (" + user_lat + "," + user_long + ") to accuracy of " + accuracy);
            location_error = false;

            // get or create the user's identity
            if (!localStorage["geopad_username"]) {
                localStorage["geopad_username"] = "mirandah";
            }
            username = localStorage["geopad_username"];

            var socket = io.connect("#{domain}"); 
            
            socket.on('connect', function() {
                socket.emit('join', "#{pad.uuid}");
            });


            socket.on('newpost-notify', function (data) {
                $("#postlist").prepend($(data).fadeIn(1000));
                // reset the form values 
                $("textarea#post-body").val("");
            });

            $("#newpost").submit(function() {		
                formdata = {
                    pad_id: $("input#pad-uuid").val(),
                    post_body: $("textarea#post-body").val(),
                    user_id: localStorage["geopad_userid"]
                };
                console.log("form data:");
                console.log(formdata);

                request = $.ajax({
                    data: decodeURIComponent($.param(formdata)),
                    type: "GET",
                    contentType: "application/json",
                    url: "/api/post/new/",
                });
                request.fail(function(msg) {
                    console.log("error:")
                    console.log(msg);
                    $("#post-error").html(msg.responseText);			
                });

                return false;
            });
        };

        geo_error = function(error) {
            console.log("Error, could not obtain location. Error " + error.code);
            location_error = true;
        };

        navigator.geolocation.watchPosition(
            geo_success, 
            geo_error, 
            {enableHighAccuracy:true}
        );




